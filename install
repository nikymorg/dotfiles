#!/bin/bash

# log install
exec > >(tee -i $HOME/dotfiles_install.log)
exec 2>&1
set -x

MACOS_CASKS=(
    1password
    appcleaner
    arq
    brave-browser
    iterm2
    google-chrome
    postman
    rectangle
    spotify
  )

MACOS_PACKAGES=(
    ctags
    neo_vim
    node
    postgresql
    ripgrep
    yarn
  )

CODESPACES_PACKAGES=(
    neo_vim
    ripgrep
    tmux
    vim
  )

function link_dotfiles {
  local dirpath="${PWD}/${1}/*"
  for filepath in $dirpath; do
    local filename=$(basename "$filepath")

    if [[ "$filename" == "nvim" ]]; then
      local nvimpath="${HOME}/.config/nvim"
      local linkpath="${nvimpath}/init.vim"
      mkdir -p "${nvimpath}"
      link_file $filepath $linkpath
    else
      local linkpath="${HOME}/.${filename}"
      link_file $filepath $linkpath
    fi
  done;
}

function link_file {
  local filepath=$1
  local linkpath=$2
  echo "linking ${filepath} to ${linkpath}"
  if [[ -f "$linkpath" ]]; then
    rm "$linkpath"
  fi
  ln -s ${filepath} ${linkpath}
}

function config_gitignore {
  git config --global core.excludesfile ~/.gitignore
}

function install_brew {
  if [[ $(command -v brew) == "" ]]; then
    echo "Installing Hombrew"
    NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    (echo; echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"') >> /home/vscode/.zprofile
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
  else
    echo "Homebrew already installed"
  fi
}

function brew_install {
  local brew_command=("${@:1}")
  local packages=("${@:2}")
  echo $brew_command

  for package in "${packages[@]}"
  do
    if [[ "$brew_command" == "cask" ]]; then
      brew install --cask $package
    else
      brew install $package
    fi
  done
}

function install_vim_plug {
  curl -fLo ~/.vim/autoload/plug.vim --create-dirs \
    https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
  vim -Es -u $HOME/.vimrc -c "PlugInstall | qa"
}

function npm_install {
  npm install --global git-open
}

function install_vim {
  # indicates codespace needs further setup
  if [[ $(command -v nvim) == "" ]]; then
    brew_install "package" "${CODESPACES_PACKAGES[@]}"
  fi
}

function default_setup {
  link_dotfiles "config"
  config_gitignore
}

function codespaces_setup {
  default_setup
  install_brew
  install_vim
  install_vim_plug
}

function mac_setup {
  default_setup
  install_brew
  brew_install "package" "${MACOS_PACKAGES[@]}"
  brew_install "cask" "${MACOS_CASKS[@]}"
  install_vim_plug
  npm_install
}

function setup {
  if [[ $CODESPACES ]]; then
    codespaces_setup
  else
    mac_setup
  fi
}

setup
