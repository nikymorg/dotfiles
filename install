#!/bin/bash

# log install
exec > >(tee -i $HOME/dotfiles_install.log)
exec 2>&1
set -x

function link_dotfiles {
  DIRPATH="${PWD}/${1}/*"
  for FILE in $DIRPATH; do
    link_file $FILE
  done;
}

function link_file {
  FILEPATH=$1
  FILE=$(basename "$FILEPATH")
  echo "linking $FILE"
  if [[ -f "${HOME}/.${FILE}" ]]; then
    rm "${HOME}/.${FILE}"
  fi
  ln -s ${FILEPATH} ${HOME}/.${FILE}
}

function config_gitignore {
  git config --global core.excludesfile ~/.gitignore
}

function install_brew {
  if [[ $(command -v brew) == "" ]]; then
    echo "Installing Hombrew"
    NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    (echo; echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"') >> /home/vscode/.zprofile
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
  else
    echo "Homebrew already installed"
  fi
}

function brew_install_casks {
  CASKS=(
    1password
    appcleaner
    arq
    brave-browser
    iterm2
    google-chrome
    postman
    rectangle
    spotify
  )

  for PACKAGE in ${CASKS[@]}
  do
    brew install --cask $PACKAGE
    if [ $? -eq 0 ]; then
      echo "$PACKAGE installed"
    else
      echo "$PACKAGE not installed"
    fi
  done
}

function brew_install_packages {
  local -n PACKAGES=$1

  for PACKAGE in ${PACKAGES[@]}
  do
    brew install $PACKAGE
    if [ $? -eq 0 ]; then
      echo "$PACKAGE installed"
    else
      echo "$PACKAGE not installed"
    fi
  done
}

function brew_install {
  PACKAGES=(
    ctags
    node
    postgresql
    ripgrep
    yarn
  )
  brew_install_packages PACKAGES
  brew_install_casks
}

function install_vim_plug {
  curl -fLo ~/.vim/autoload/plug.vim --create-dirs \
    https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
  vim -Es -u $HOME/.vimrc -c "PlugInstall | qa"
}

function npm_install {
  npm install --global git-open
}

function default_setup {
  link_dotfiles "config"
  config_gitignore
  install_vim_plug
}

function install_vim {
  PACKAGES=(
    ripgrep
    tmux
    vim
  )
  # indicates codespace needs further setup
  if [[ $(command -v vim) == "" ]]; then
    brew_install_packages PACKAGES
  else
    echo "Vim already installed"
  fi
}

function codespaces_setup {
  default_setup
  install_brew
  install_vim
}

function mac_setup {
  default_setup
  install_brew
  brew_install
  npm_install
}

function setup {
  if [[ $CODESPACES ]]; then
    codespaces_setup
  else
    mac_setup
  fi
}

setup
